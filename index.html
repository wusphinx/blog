<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>just for fun!</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link href=/index.xml rel=alternate type=application/rss+xml title="just for fun!"><link href=/index.xml rel=feed type=application/rss+xml title="just for fun!"><meta property="og:title" content="just for fun!"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="http://example.org/"><meta itemprop=name content="just for fun!"><meta itemprop=description content><meta name=twitter:card content="summary"><meta name=twitter:title content="just for fun!"><meta name=twitter:description content></head><body class="ma0 avenir bg-near-white"><header><div class="pb3-m pb6-l bg-black"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">just for fun!</a><div class="flex-l items-center"></div></div></nav><div class="tc-l pv3 ph3 ph4-ns"><h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">just for fun!</h1></div></div></header><main class=pb7 role=main><article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray"></article><div class="pa3 pa4-ns w-100 w-70-ns center"><h1 class=flex-none>Recent Posts</h1><section class="w-100 mw8"><div class="relative w-100 mb4"><article class="bb b--black-10"><div class="db pv4 ph3 ph0-l no-underline dark-gray"><div class="flex flex-column flex-row-ns"><div class="blah w-100"><h1 class="f3 fw1 athelas mt0 lh-title"><a href=/posts/dubbogo%E5%85%A5%E9%97%A8/ class="color-inherit dim link">Dubbogo入门</a></h1><div class="f6 f5-l lh-copy nested-copy-line-height nested-links">鉴于我司java技术栈为主这个事实，go作为小众，为了使用公司的dubbo基础设施，只有三条路可以走：
让dubbo应用开发者提供http协议接口(你确定别人愿意花额外的时间干这件事？)，此路不通； 自己用java开发一个http网关，将dubbo接口以http方式暴露出来，也不是不行，但java真的不熟，要是熟，也就不必开发这个网关了； 直接使用go开发dubbo接口的consumer，dubbogo支持这种方式 虽然不是一个绝对的外行，但对于dubbo的一些基本概念还是要理清楚的，一图胜千言 通常zk作为图中的Registry，为服务发现之中 Provider自然就是java提供的dubbo接口了 Consumer就是go写的dubbo调用方了 dubbogo是dubbo的golang实现，由此我们可以使用go作为Consumer，调用java写的dubbo接口方法，为了方便观察，我在本地启动了一个dubbo-server、zk以及dubbo-admin
docker-compose配置如下所示：
# refer:https://github.com/apache/dubbo-admin/blob/develop/docker/stack.yml version: '3' services: zookeeper: image: zookeeper ports: - 2181:2181 admin: image: apache/dubbo-admin:0.3.0 depends_on: - zookeeper ports: - 8080:8080 environment: - admin.registry.address=zookeeper://zookeeper:2181 - admin.config-center=zookeeper://zookeeper:2181 - admin.metadata-report.address=zookeeper://zookeeper:2181 用IDEA启动dubbo-server端：https://github.com/apache/dubbo-go-samples/tree/master/generic/java-server/2.7，记住项目编译版本一定要选择java8(不要问了怎么知道的)，打开dubbo-admin（用户名密码均为:root），此时可以顺利看到服务注册信息
这说明dubbo服务端启动成功且成功将自身信息注册到了zk，下一步我们启动go客户端：https://github.com/apache/dubbo-go-samples/tree/master/generic/go-client
CONF_CONSUMER_FILE_PATH=conf/client.yml go run cmd/client.go 没有明显的报错，我们可以调用是成功的，如果你有注意到IDEA这边的日志，可以发现go客户端的调用确实是成功的，问题在于dubbo-admin这里的信息发生了变化
从现象看就是go consumer的注册信息“覆盖”了java provider的信息，当然，这是表象，如果真的覆盖，go consumer的调用不可能成功的，我们查看一下zk里面的注册信息
[zk: localhost:2181(CONNECTED) 2] ls / [dubbo, zookeeper] 看看dubbo目录
[zk: localhost:2181(CONNECTED) 3] ls /dubbo [config, org.apache.dubbo.UserProvider] 进到UserProvider中
[zk: localhost:2181(CONNECTED) 7] ls /dubbo/org.</div><a href=/posts/dubbogo%E5%85%A5%E9%97%A8/ class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a></div></div></div></article></div><div class="relative w-100 mb4"><article class="bb b--black-10"><div class="db pv4 ph3 ph0-l no-underline dark-gray"><div class="flex flex-column flex-row-ns"><div class="blah w-100"><h1 class="f3 fw1 athelas mt0 lh-title"><a href=/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/ class="color-inherit dim link">软件中间层</a></h1><div class="f6 f5-l lh-copy nested-copy-line-height nested-links">计算机领域有句名言
计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决
最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。
监控告警 因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路
prometheus：数据收集 alertmanager：接收告警 webhook：告警通道分发 exporter：指标采集 grafana：可视化 想的很美好，遇到的第一个问题可把我愣住了：
公司近期做降本增效，这些服务的虚拟机申请不给批； 公司有人在用prometheus,但都是历史原因自已用，没专人维护 因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter） 团队监控业务与公司数据采集服务不在同一网络 根据与运维部门的沟通，我得到的结果：
你不能自己玩prometheus那一套，我们不会给资源的 你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式 你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地 此处必须引用老玩家C的一条微博
什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。
这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？
prometheus配置remote write到数据转换服务S 服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务 由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了 所以你看，通过使用中间层服务S，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？
网关配置 之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：
URI参数配置过长，且有顺序要求； URI的不同Method需要分别配置； 针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了
将{param1}/{param2}写法统一成{param}/{param}，{param}只是作为占位符 Method支持多个同时配置，如POST,GET,PUT 支持连续参数的简化语法，如{param@num}，num为3，则最后转换成{param1}/{param2}/{param3}的形式 而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。
这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。</div><a href=/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/ class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a></div></div></div></article></div><div class="relative w-100 mb4"><article class="bb b--black-10"><div class="db pv4 ph3 ph0-l no-underline dark-gray"><div class="flex flex-column flex-row-ns"><div class="blah w-100"><h1 class="f3 fw1 athelas mt0 lh-title"><a href=/posts/api%E7%BD%91%E5%85%B3%E4%B9%8Bkrakend/ class="color-inherit dim link">API网关之krakend</a></h1><div class="f6 f5-l lh-copy nested-copy-line-height nested-links">这一篇已经拖了好久了，以至于提笔开始写的时候，krakend项目已经改名为lura了，而且这个网关项目还进入到了CNCF中，真的是士别三日，当刮目相看了。不知不觉，我使用的这个开源项目作为团队的业务网关都已经上线了。
当初我为什么要选择这个网关呢？首先团队跟外部沟通的协议为HTTP，有一些鉴权需求，本身业务量并不大，需要支持自定义插件的，最好是用golang写的，便于维护。从功能上来讲，其实nginx非常符合我的需求，除了技术栈，我只用了几天时间调研试用，就迅速确定了krakend作为API网关的框架，使用简单，性能还很强的样子。当然，从业务量上来讲，性能不是第一优先级，我需要解决的是从无到有的问题。
我所在的团队属于初创，后端这部分有好几个人在写，功能上重复，每个人都跟自己的业务前端对接，部门所做的几个功能都挺分散的，再加上权限控制的需求愈发强烈，网关的必要性就凸显出来了。短短不到百行代码，就能创建一个API网关，这是我选择的主要原因。
package main import ( "flag" "log" "os" "github.com/luraproject/lura/config" "github.com/luraproject/lura/logging" "github.com/luraproject/lura/proxy" "github.com/luraproject/lura/router/gin" ) func main() { port := flag.Int("p", 0, "Port of the service") logLevel := flag.String("l", "ERROR", "Logging level") debug := flag.Bool("d", false, "Enable the debug") configFile := flag.String("c", "/etc/lura/lura.json", "Path to the configuration filename") flag.Parse() parser := config.NewParser() serviceConfig, err := parser.Parse(*configFile) if err != nil { log.Fatal("ERROR:", err.Error()) } serviceConfig.Debug = serviceConfig.Debug || *debug if *port !</div><a href=/posts/api%E7%BD%91%E5%85%B3%E4%B9%8Bkrakend/ class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a></div></div></div></article></div></section><section class=w-100><h1 class=f3>More</h1><h2 class="f5 fw4 mb4 dib mr3"><a href=/posts/api%E7%BD%91%E5%85%B3%E9%80%89%E5%9E%8B/ class="link black dim">API网关选型</a></h2><h2 class="f5 fw4 mb4 dib mr3"><a href=/posts/%E4%BF%AE%E4%BB%99/ class="link black dim">修仙</a></h2><h2 class="f5 fw4 mb4 dib mr3"><a href=/posts/gomod%E4%BE%9D%E8%B5%96%E5%8C%85%E5%A4%84%E7%90%86/ class="link black dim">go mod依赖包处理</a></h2><h2 class="f5 fw4 mb4 dib mr3"><a href=/posts/%E8%AE%B0%E4%B8%80%E6%AC%A1http%E8%BF%9E%E6%8E%A5%E9%87%8D%E7%94%A8%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/ class="link black dim">记一次HTTP连接重用问题分析</a></h2><a href=/posts/ class="link db f6 pa2 br3 bg-mid-gray white dim w4 tc">All Posts</a></section></div></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://example.org/>&copy; just for fun! 2021</a><div></div></div></footer></body></html>