<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>软件中间层 | just for fun!</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="计算机领域有句名言
 计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决
 最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。
监控告警 因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路
 prometheus：数据收集 alertmanager：接收告警 webhook：告警通道分发 exporter：指标采集 grafana：可视化  想的很美好，遇到的第一个问题可把我愣住了：
 公司近期做降本增效，这些服务的虚拟机申请不给批； 公司有人在用prometheus,但都是历史原因自已用，没专人维护 因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter） 团队监控业务与公司数据采集服务不在同一网络  根据与运维部门的沟通，我得到的结果：
 你不能自己玩prometheus那一套，我们不会给资源的 你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式 你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地  此处必须引用老玩家C的一条微博
 什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。
 这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？
 prometheus配置remote write到数据转换服务S 服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务 由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了  所以你看，通过使用中间层服务S，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？
网关配置 之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：
 URI参数配置过长，且有顺序要求； URI的不同Method需要分别配置；  针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了
 将{param1}/{param2}写法统一成{param}/{param}，{param}只是作为占位符 Method支持多个同时配置，如POST,GET,PUT 支持连续参数的简化语法，如{param@num}，num为3，则最后转换成{param1}/{param2}/{param3}的形式  而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。
这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="软件中间层"><meta property="og:description" content="计算机领域有句名言
 计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决
 最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。
监控告警 因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路
 prometheus：数据收集 alertmanager：接收告警 webhook：告警通道分发 exporter：指标采集 grafana：可视化  想的很美好，遇到的第一个问题可把我愣住了：
 公司近期做降本增效，这些服务的虚拟机申请不给批； 公司有人在用prometheus,但都是历史原因自已用，没专人维护 因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter） 团队监控业务与公司数据采集服务不在同一网络  根据与运维部门的沟通，我得到的结果：
 你不能自己玩prometheus那一套，我们不会给资源的 你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式 你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地  此处必须引用老玩家C的一条微博
 什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。
 这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？
 prometheus配置remote write到数据转换服务S 服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务 由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了  所以你看，通过使用中间层服务S，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？
网关配置 之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：
 URI参数配置过长，且有顺序要求； URI的不同Method需要分别配置；  针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了
 将{param1}/{param2}写法统一成{param}/{param}，{param}只是作为占位符 Method支持多个同时配置，如POST,GET,PUT 支持连续参数的简化语法，如{param@num}，num为3，则最后转换成{param1}/{param2}/{param3}的形式  而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。
这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。"><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-25T22:37:16+08:00"><meta property="article:modified_time" content="2021-08-25T22:37:16+08:00"><meta itemprop=name content="软件中间层"><meta itemprop=description content="计算机领域有句名言
 计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决
 最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。
监控告警 因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路
 prometheus：数据收集 alertmanager：接收告警 webhook：告警通道分发 exporter：指标采集 grafana：可视化  想的很美好，遇到的第一个问题可把我愣住了：
 公司近期做降本增效，这些服务的虚拟机申请不给批； 公司有人在用prometheus,但都是历史原因自已用，没专人维护 因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter） 团队监控业务与公司数据采集服务不在同一网络  根据与运维部门的沟通，我得到的结果：
 你不能自己玩prometheus那一套，我们不会给资源的 你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式 你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地  此处必须引用老玩家C的一条微博
 什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。
 这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？
 prometheus配置remote write到数据转换服务S 服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务 由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了  所以你看，通过使用中间层服务S，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？
网关配置 之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：
 URI参数配置过长，且有顺序要求； URI的不同Method需要分别配置；  针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了
 将{param1}/{param2}写法统一成{param}/{param}，{param}只是作为占位符 Method支持多个同时配置，如POST,GET,PUT 支持连续参数的简化语法，如{param@num}，num为3，则最后转换成{param1}/{param2}/{param3}的形式  而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。
这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。"><meta itemprop=datePublished content="2021-08-25T22:37:16+08:00"><meta itemprop=dateModified content="2021-08-25T22:37:16+08:00"><meta itemprop=wordCount content="37"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="软件中间层"><meta name=twitter:description content="计算机领域有句名言
 计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决
 最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。
监控告警 因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路
 prometheus：数据收集 alertmanager：接收告警 webhook：告警通道分发 exporter：指标采集 grafana：可视化  想的很美好，遇到的第一个问题可把我愣住了：
 公司近期做降本增效，这些服务的虚拟机申请不给批； 公司有人在用prometheus,但都是历史原因自已用，没专人维护 因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter） 团队监控业务与公司数据采集服务不在同一网络  根据与运维部门的沟通，我得到的结果：
 你不能自己玩prometheus那一套，我们不会给资源的 你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式 你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地  此处必须引用老玩家C的一条微博
 什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。
 这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？
 prometheus配置remote write到数据转换服务S 服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务 由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了  所以你看，通过使用中间层服务S，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？
网关配置 之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：
 URI参数配置过长，且有顺序要求； URI的不同Method需要分别配置；  针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了
 将{param1}/{param2}写法统一成{param}/{param}，{param}只是作为占位符 Method支持多个同时配置，如POST,GET,PUT 支持连续参数的简化语法，如{param@num}，num为3，则最后转换成{param1}/{param2}/{param3}的形式  而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。
这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">just for fun!</a><div class="flex-l items-center"></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=http://example.org/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=http://example.org/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/&text=%e8%bd%af%e4%bb%b6%e4%b8%ad%e9%97%b4%e5%b1%82" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=http://example.org/posts/%E8%BD%AF%E4%BB%B6%E4%B8%AD%E9%97%B4%E5%B1%82/&title=%e8%bd%af%e4%bb%b6%e4%b8%ad%e9%97%b4%e5%b1%82" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">软件中间层</h1><time class="f6 mv4 dib tracked" datetime=2021-08-25T22:37:16+08:00>August 25, 2021</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>计算机领域有句名言</p><blockquote><p>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</p></blockquote><p>最近在工作中我就通过增加中间层来解决了看似需要换方案或推倒重来的问题。</p><h2 id=监控告警>监控告警</h2><p>因为前司的监控告警方案是我拟定并实现的，用的是Prometheus生态那一套，基本上是以下思路</p><ul><li>prometheus：数据收集</li><li>alertmanager：接收告警</li><li>webhook：告警通道分发</li><li>exporter：指标采集</li><li>grafana：可视化</li></ul><p>想的很美好，遇到的第一个问题可把我愣住了：</p><ol><li>公司近期做降本增效，这些服务的虚拟机申请不给批；</li><li>公司有人在用prometheus,但都是历史原因自已用，没专人维护</li><li>因为开源时序数据库性能不能满足需求，公司开发了独立的数据采集方案：tracer(不同于prometheus的exporter）</li><li>团队监控业务与公司数据采集服务不在同一网络</li></ol><p>根据与运维部门的沟通，我得到的结果：</p><ol><li>你不能自己玩prometheus那一套，我们不会给资源的</li><li>你可以用公司的数据采集方案，但是需要你自己将监控指标数据转成tracer的格式</li><li>你可以等待运维部门出兼容方案，因为人员有限，这一季度调研，下季度落地</li></ol><p>此处必须引用老玩家C的一条微博</p><blockquote><p>什么是工程思维？——永远以资源有限、条件不足为前提，去实现现实世界的目标。</p></blockquote><p>这不正是资源有限，条件不足的现实场景吗？prometheus这一套体系我是熟悉的，必须接入公司的tracer，加一个中间层？</p><ol><li>prometheus配置remote write到数据转换服务S</li><li>服务S将prometheus数据转换成tracer格式，并上传到公司的数据采集服务</li><li>由于接入公司监控系统，所以很自然可以借力公司的告警系统，不必自己写webhook了</li></ol><p>所以你看，通过使用中间层<strong>服务S</strong>，我使用了自己熟悉的技术，又可以借力公司现有的能力，其实问题并没有想像中那么难，不是吗？</p><h2 id=网关配置>网关配置</h2><p>之前吐槽过目前我正在使用的网关：krakend,原因就在于它的配置复杂且繁琐，不支持正则，模板难用，以至于随着组内微服务规模的扩张，配置成了一个不小的负担，因为团队只有我懂，只有我会配。我想换网关，以解决配置繁琐的问题，但由于手头业务重，暂时也抽不出大量时间换其它网关，况且换也是有成本和风险的，痛定思痛，我整理了一下所谓的“痛点”问题：</p><ol><li>URI参数配置过长，且有顺序要求；</li><li>URI的不同Method需要分别配置；</li></ol><p>针对这两个问题，其实很容易想到简化配置的方案，在配置文件和网关真正载入配置中间加一个中间层，将简化的配置转化成网关的繁杂配置，于是问题就变成写正则了</p><ol><li>将<code>{param1}/{param2}</code>写法统一成<code>{param}/{param}</code>，<code>{param}</code>只是作为占位符</li><li>Method支持多个同时配置，如<code>POST,GET,PUT</code></li><li>支持连续参数的简化语法，如<code>{param@num}</code>，num为3，则最后转换成<code>{param1}/{param2}/{param3}</code>的形式</li></ol><p>而且兼容新老写法，于是配置不再是一个令人头疼的问题，而且我发现这种相对严格的配置方式其实挺好的，至少是明确的，如果使用正则，很容易会将内部不应暴露出的资源暴露出去。</p><p>这两件事情若放在以前，我大概率会使用推倒换方案的路数，但是现如今资源有限，要解决从0到1的问题，还要兼顾历史，我认为加中间层这个思路非常合适当下，既增加了灵活性，又保留了换方案的可能性，而且团队借力后，能更专注于核心业务，这或许就是成长吧。道理，都懂，只是，这一次从实践中第一次较为深刻的理解了，我相信，这对我之后的工作大有裨益。</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://example.org/>&copy; just for fun! 2021</a><div></div></div></footer></body></html>