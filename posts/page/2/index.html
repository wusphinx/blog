<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>just for fun!</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/ananke/css/main.min.css><link href=/posts/index.xml rel=alternate type=application/rss+xml title="just for fun!"><link href=/posts/index.xml rel=feed type=application/rss+xml title="just for fun!"><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="http://example.org/posts/"><meta itemprop=name content="Posts"><meta itemprop=description content><meta name=twitter:card content="summary"><meta name=twitter:title content="Posts"><meta name=twitter:description content></head><body class="ma0 avenir bg-near-white"><header><div class="pb3-m pb6-l bg-black"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">just for fun!</a><div class="flex-l items-center"></div></div></nav><div class="tc-l pv3 ph3 ph4-ns"><h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">Posts</h1></div></div></header><main class=pb7 role=main><article class="pa3 pa4-ns nested-copy-line-height nested-img"><section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray"></section><section class="flex-ns flex-wrap justify-around mt5"><div class="relative w-100 w-30-l mb4 bg-white"><div class="relative w-100 mb4 bg-white nested-copy-line-height"><div class="bg-white mb3 pa4 gray overflow-hidden"><span class="f6 db">Posts</span><h1 class="f3 near-black"><a href=/posts/%E8%B0%88%E8%B0%88%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%B7%AF/ class="link black dim">谈谈容器化的实践思路</a></h1><div class="nested-links f5 lh-copy nested-copy-line-height">老实说，这是一个挺大的话题，盲目谈论有点大言不惭，不过，笔记打算从自己的工作经历中聊聊这个话题。
彼时，笔者还在成都，那时Golang还很新，版本还牌1.10以下，容器化在当时的技术领域是一项非常时髦的技术，当时我所在的团队，已经开始尝试服务容器化了，容器的管理平台使用的时开源的容器管理平台Rancher 1.x版本（当时还没有使用k8s，不过运维团队已开始预研），当时团队自动化程度较高，Dockerfile也不是开发自己写的，而是由项目初始化工具生成Dockerfile及.gitlab-ci.yml模板，然后经由CI/CD平台（用的是gitlab runner）编辑打包然后部署，整个流程如下所示：
当时测试环境有test、demo等，都是相互隔离的，以提交时的分支名确定应该部署到哪个环境，比如当时时test分支，提交代码之后，应用就部署到test环境。这一套流程最大的好处是从提交代码开始，CI/CD就开始进行，且中间没有阻隔，所以开发测试的效率非常高，迭代很迅速，这段工作经历是我的DevOps思想的启蒙。
来到杭州以后，第一份工作是在某操做容器化的推进，公司的技术栈以Java为主，推进容器化的动机是因为测试环境非常混乱，希望能够通过服务容器化，减少测试环境的机器，以达到节省成本的目的。（值得一提的是，当时还没有谈到推进容器化上生产这一步，对此我表示很惊讶）。当时测试环境的混乱情况到了何种地步，且我娓娓道来：
其中选择空闲机器这一步，因为机器不足分布不均的有关系，会出现张三将机器上某个应用A杀掉从而部署应用B；触发jenkins任务这一步经常会失败，因为这一步通常是由测试人员去完成的，编译打包过程出现一些问题也在所难免，最后又得找到开发；再说部署这一步，因为应用部署前需要将自己注册到网关，这一步因为某些原因经常出现异常，从而导致部署中断，此时测试人员又得找到运维……我描述的还只是当时所见到的一小部分，这种混乱主要原因在于开发、运维、测试的割裂，各自完成自己所做的那一部署然后就不管了，由于常见的部门墙等因素，跨部门合作也不算很容易，所以经常可见的项目延期上线，以我的角度，DevOps几近于没有，因为我没有看到合作，团队和部门都是各自为政，当然，这也并非个案。 在这种情况下要推进容器化并非易事（话又说回来，要是容易的话，也就没我什么事了）。出于个人经验，你首先想到的是改造CI/CD，将我在前司的研发流程带到公司。于是，从DevOps的受益者变成设计者，我首先完成了一套基于gitlab的CI/CD流程的demo，在团队内做了一次分享，不过可惜的是，当时团队成员觉得思路挺好，就是和现有以Jenkins为主的流程有些差异，不容易为人所接受。现有想想，当时也确实过于激进，毕竟我所接触到的同事，他们也只用过Jenkins，而且由于职能的原因，每个人相对只关心于自己的任务线。虽说有点受挫，不过笔者当时并没有放弃，而是找gitlab的维护人员，希望他们能够安装gitlab runner，不过得到的回复是：我们现在已经有了jenkins，没有必要也不能安装gitlab runner了……
没法，容器化总也要推进，根据当时的服务容器化的需求，当然，是直接上k8s的，我们首先做的一件事情是进行硬件资源评估，然后申请机器部署k8s集群，然后着手公司服务拓扑图，没想到在这一步遇到了难题，由于业务线各自为政，没有一个全局的服务依赖关系，无奈之下，经过商议，为了证明容器化的可用性，只好先将某一个业务线的服务部署到我们的k8s集群中，由于业务不熟悉，期间也花了不少时间在打包以及调试上。 其中渲染资源文件模板本来是可以用helm的chart包来替代的，不过自己写deployment、service、ingress模板其实也可以达到目的，只不过因为要部署到k8s的关系，需要另做一套平台来部署，其实并没做DevOps，只是硬生生的将原有的那一套流程搬到容器化中而已，所以，即使我离职已经一年有余，这一套流程听说也没有最终落地，实在令人唏嘘。
前司某医的容器化之路也是坎坷，项目起步于2018年，容器化的动机据不完全了解是为了让公司跟上技术的发展潮流。公司技术栈同样以Java为主，不过还有少数php、golang以及python应用（当然，我用golang写的监控服务必须是容器化的）。整个流程如下所示
所谓个性化部署参数这里要特别解释一下：就是写一个CRD，这个CRD定义了一些参数如：appname、requests、limits、port等，简单说就是将deployment的参数以CRD的形式暴露出来，最后形成所下所示的k8s资源：
kind: Deployment apiVersion: extensions/v1beta1 metadata: name: myapp labels: appname: myapp spec: replicas: 1 template: spec: containers: - name: myapp image: myapp:5.0.3 ports: - containerPort: 80 resources: limits: memory: 600Mi cpu: 1 requests: memory: 300Mi cpu: 500m …… 如果定义一个服务也有三类资源如：deployment、service、ingress，那么这个CRD的作用就在于依据入参生成这三类资源并且部署到k8s集群中，由controller来保证每个应用，这三种资源都保持与CRD的定义一致。这也是容器化的一种思路，也是典型的CRD应用。 坦白说，就算不写CRD，也能达到这个目的，写CRD的目的是为了将应用模型进行统一，形式上就是尽可以将通用的资源参数暴露出来以供个性化使用，无奈之处在于还是在走容器化适配应用的路数，还不是将应用进行容器化适配，比如，dubbo的服务发现由zk提供，不过zk目前是在k8s外围，从功能上来讲，zk一定程序上跟k8s的service存在重复；应用内存使用是4G起步，虽说是为了保险起见，不过，这说明服务本身过重了，当然，硬件资源充足的情况下，这也不算是很大的问题；dubbo有自己的负载均衡，jvm可能也能限制资源的使用，作为容器化的拥趸，我不禁对java容器化的意义产生了一丝怀疑，诚然，k8s可以做hpa，可以自动重启，这些都是优势，但是到底真正的收益在哪里呢？ （截止文章发布之日，前司的容器化之路依然还在进行中）
容器化固然只是一句口号而已，而这句口号，却常常伴随着DevOps这个词语，依我个人的浅见，DevOps是一种开放合作的文化，它打破了软件开发过程中的各个职能界限，最终是为了提高工作效率，从提高工作效率这个角度来看，DevOps在我的职业生涯中依旧少见。
毫不掩饰的说，我对Jenkins有一丝偏见，因为我从事的公司中，使用Jenkins的方式无一例外，都是反DevOps的，设置流程的障碍，需要多方介入，但这种使用形成了一种习惯，我并不反对Jenkins，但如果使用Jenkins让事情变得更容易，我自然欣然接受，比如使用gitlab的CI/CD，就让人觉得很舒服，扩展性也挺好，这也是一个习惯问题。
前司的容器化之路依旧在进行中，而我，也有自己对于容器化的想法，如下所示
以轻巧的k3s作为CI平台，可以将gitlab runner接入进来，当然，每个应用有自己对于CI的需求，对于资源的需求，所以项目repo中也应该包含.gitlab-ci.yml、Dockerfile等，选择k3s来做CI的运行平台自然是为了利用k8s的资源调度和扩展性了；选择gitops是为了将CI/CD解耦，这样，就有DevOps内味了。
自己的一点浅见，欢迎各位拍砖！</div></div></div></div><div class="relative w-100 w-30-l mb4 bg-white"><div class="relative w-100 mb4 bg-white nested-copy-line-height"><div class="bg-white mb3 pa4 gray overflow-hidden"><span class="f6 db">Posts</span><h1 class="f3 near-black"><a href=/posts/2019%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/ class="link black dim">2019年终总结</a></h1><div class="nested-links f5 lh-copy nested-copy-line-height">2019年还是发生挺多事的，一直在想该如何写，拖到现在，这是病，得治。
西南飞东南 2019年初辞去成都的工作，来到了一家能源出行企业，从4年后端开发转变成为了一名“资深测试开发”，口味从无辣不欢到清新寡淡，变化让人惊喜，也带着些淡淡不适。
手机自动化测试 头三个月，从没接触过手机端开发的我接到做自动化测试平台任务，于是自备的锤子、苹果手机派上了用场，从领导的推荐开源项目UICrawler到自己发现的AppCrawler，拿来主义终归是没有找到满意的答案，又开始研究Appium自己写遍历代码，使用阿里的Macaca测试方案，还提了自己pr，研究Fastmonkey、Maxim等第三方解决方案，始终还是不够满意，最后以为Airtest是银弹，结果发现并不满足于自动化的要求，发现目的有一些迷失、不清晰，最后也是以调研解决方案的demo形式完成了入职答辩，感觉很潦草，但是领导觉得还行，走出了从0到1这一步。
服务容器化 因项目需要终止了手机自动化测试的工作，加入到了服务容器化小组，说是小组，也就是我跟另外一位同事罢了。内心还是挺兴奋的，对手机自动化已经没啥兴趣了，服务容器化呢，因为开发经历的原因，是容器化的重度使用者，但从没有参与容器化的建设与设计。
rancher vs kubeadm 从加入容器化项目伊始，因如何安装k8s集群产生了分歧，由于经验的关系，我强烈推荐Rancher，原因是这是一套开源的k8s管理平台，很适合我们这种小团队，人手也不够。不过我没想到遇到了强大的阻力，另外一位同事觉得就应该用k8s原生的安装方式，原因是可以更好的“研究”k8s。后来我后现所谓的研究也只是安装k8s集群而已，并没有深入代码及k8s架构及其原理，我果断强推了一把rancher，先用rke搭建k8s用起来，让大家能看到rancher的易用性，虽然那位同事由于习惯的原因，依旧固执的要再安装一个k8s自带的dashboard, 但我总算是将rancher用起来了，由此这一争论算是告一段落了
centos vs alpine 容器项目的基础镜像用的centos，最终打包出来的镜像竟然有600M之多，我感觉很震惊，于是问为什么这么做，答曰：因为生产环境用的centos，为了稳定性，要保持一致。于是我开始了争取使用alpine做基础镜像之路，本机下载服务源码，自己打镜像，推到镜像仓库，又折腾了一番java服务，真是一言难尽。为此我仔细想了下为什么要用alpine，用几个考量：轻量化、下载快速、标准化。但是推行的过程同样很艰辛，作为项目的后来参与者，要跟前辈们争取，最后却被认为是激进。
模板 vs helm 服务部署在k8s里面初始形态就是各种资源文件，比如Service、Deployment、Ingress等等，可以自己模板，然后参数渲染，我刚进容器化团队的时候发现他们以前也是这么做的，但是写的过于丑陋。随着对k8s生态的了解，我在社区发现了Helm这一软件包工具，觉得很棒，为此还专门在团队内部做了一个分享，想推广使用Helm，以节省工作量，没想到依赖遭遇了强烈的反对，后来我才想明白，因为先期已经做了一个“容器平台”专门做模板渲染，Helm难免有抢功之嫌，此时我对人性有了新的理解，不过我依然热忠于做技术。
Jenkins vs gitlab 公司没有CI/CD基础设施，本着实践基础设施即代码的原则以及过往的工作经验，我用gitlab做了一个CI/CD流水线的demo演示，还向运维部门申请安装gitlab runner，得到的反馈：我们已经有了Jenkins，不用安装gitlab runner，CI/CD跟当前项目推进方案差别过大，连我们领导也没有经历这种自动化的开发部署方式，自然也难以获得支持，问题是没有CI/CD的支持，如果做容器化？没有办法，只有靠手动人力来做了
化整为零 公司是Java技术栈，Dockerfile不知什么原因用的是同一个，容器里面再套上脚本以作区分处理，这个做法几乎沿用了当前部署的模式，当时我觉既复杂又丑陋，自己花了点心思，将服务按类型整理成4种不同的Dockerfile，找不同的服务做测试，费了点工夫，也没有多少人反对，毕竟这是个吃力不讨好的活，不过直至离职时，这一方案才勉强被采用。
容器化的理解 服务容器化的初始目标是提高测试环境的运行效率，减少机器使用量，在初期，只是将原有的服务打包扔进容器中而已，这种机械的做法并不能实现服务容器化这件事，没有代码配置书写规范，没有DevOps使用文化，没有基础设施，没有架构的调整，是没法做成容器化的，不能让k8s来适应公司的服务架构，要想清楚为什么要容器化，为了节省机器？坦白讲，我没发现能省机器；流量染色？仅凭概念也没法做，合作推进受到了比较大的阻力，领导也不看好这个项目，一个字，难。(ps：容易的话还要你做？)
自下而上 vs 自上而下 作为资深测开，做着运维开发的活，却身在质量团队，在软件研发体系里面，处于较下的位置，没有多少人会认为质量团队有多少技术含量，甚至于一些自己人也觉得技术上是不如开发的，这就造成了自下而上推广的困难：信任。说实话，以前呆在开发团队，并没有觉得会有这种上上下下的问题，直至自己真实的遇到才后知后觉。如果领导一锤定音，是否容器化这件事就能更容易落地？
心生去意 容器化推进困难，没有多少成效，小组受到一些非议，不得已竟然要接业务测试的活，领导也打算放弃容器化项目了，而我对k8s这一生态非常感兴趣，所以尴尬的是是想做的无法落地，不感兴趣的却要做，怎么办，其实内心已有答案：做技术。坦白讲，公司从来不是技术优先的，背靠传统企业，自然政治意味比较浓。
辞职 裸辞 做出这一决定的原因一是不想给自已留后路，二是确实也没有想好做什么方向，三是单纯想尝试一下
方向 开发再加半年的k8s使用经验，对方向又迷茫了，思索再三，定了几个：1. k8s开发；2. 人工智能 3. 区块链 4. 物联网。这是自己想做的方向，并非优势所在
求职 面试第一家就拿到了offer, 做golang框架开发，写烦的纯业务的我，有点心动，不过因为公司较小，当时我竟然拒绝了
第二家做区块链，有笔试题，毫无准备的情况下，竟然连基本的SQL都写错了，结局自己是败了；
第三家面某为，一面还算轻松，二面算法题竟然没做对，现在想想还是准备不足，非常可惜，工作内容偏底层，做编程语言及编译器相关开发，只恨自己当时不够用心。
经历两周无试可面的情况下，在保证信息准备的情况下，对简历进行了润色，开始接连面试海康威视的容器平台开发，我有k8s使用经历，但无开发实践，全程尬聊，不欢而散；面西子联合旗下的工业互联网，跟技术与hr都聊的很high，最终竟然没有合到offer；小象教育，因为有所准备，笔试做的很好，一面挺不错，二面面试架构设计：笔记类应用设计，还有点带压力面，全线崩溃，深知自己架构能力的不足；面中控蓝卓，一面很轻松，二面觉得我做过的东西没啥难度，尤其听说我最近一段工作经历是测开，立马开始敷衍，虽自知结果，但面完也没有主动给通知；威佩网络面试有尝试，也有广度，有架构设计，但是最后给的offer实在是让觉得不快，工资没涨，所以也没接受；后面拿到两家区块链企业，都不是自己想去的，不过授受了其中一家的offer， 在入职前几天，面试了另一家做k8s开发的岗位，相谈甚欢，也算是一拍即合，果断放弃区块链offer。
总结 这一年，在容器化推进的过程中，积累了很多负能量，归根到底，还是能力不足，想做的事又很大很多，找工作的过程更是发现自己知识积累泛而不深，广而不精，焦虑的同时也比较迷茫，最终工作的方向还是满足找工作的期望，只是深知以后进大厂会更难了，不过这也更能激励自己，做好技术冷板凳，人若无名，便可专心练剑。2020年：把小事做好，把技术做精，少一些无用的焦虑，多一些实在的积累，量变终将引起质变，加油。</div></div></div></div><div class="relative w-100 w-30-l mb4 bg-white"><div class="relative w-100 mb4 bg-white nested-copy-line-height"><div class="bg-white mb3 pa4 gray overflow-hidden"><span class="f6 db">Posts</span><h1 class="f3 near-black"><a href=/posts/%E6%8E%A2%E7%A9%B6golang%E7%9A%84linkname/%E6%8E%A2%E7%A9%B6golang%E7%9A%84linkname/ class="link black dim">探究golang的linkname</a></h1><div class="nested-links f5 lh-copy nested-copy-line-height">在编写golang程序的过程中，会经常有一些sleep的需求，于是我们使用time.Sleep函数 跳转到函数定义处发现这个函数定义如下：
// Sleep pauses the current goroutine for at least the duration d. // A negative or zero duration causes Sleep to return immediately. func Sleep(d Duration) 没错，只有定义没有实现？显然不是，函数的实现在runtime/time.go
// timeSleep puts the current goroutine to sleep for at least ns nanoseconds. //go:linkname timeSleep time.Sleep func timeSleep(ns int64) { if ns &lt;= 0 { return } gp := getg() t := gp.timer if t == nil { t = new(timer) gp.</div></div></div></div></section><ul class="pagination pagination-default"><li class=page-item><a href=/posts/ aria-label=First class=page-link role=button><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/posts/ aria-label=Previous class=page-link role=button><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a href=/posts/ aria-label="Page 1" class=page-link role=button>1</a></li><li class="page-item active"><a href=# aria-current=page aria-label="Page 2" class=page-link role=button>2</a></li><li class="page-item disabled"><a href=# aria-disabled=true aria-label=Next class=page-link role=button tabindex=-1><span aria-hidden=true>&#187;</span></a></li><li class="page-item disabled"><a href=# aria-disabled=true aria-label=Last class=page-link role=button tabindex=-1><span aria-hidden=true>&#187;&#187;</span></a></li></ul></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://example.org/>&copy; just for fun! 2021</a><div></div></div></footer></body></html>